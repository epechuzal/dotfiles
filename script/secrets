#!/bin/zsh
# Manages .localrc by pulling from 1Password

set -e

# Get the dotfiles root directory (one level up from script/)
DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
LOCALRC_SYMLINK="$DOTFILES_ROOT/localrc.symlink"
LOCALRC_TARGET="$HOME/.localrc"

OP_ITEM_NAME="dotfiles-localrc"
OP_VAULT="${OP_VAULT:-Homelab secrets}"

# Check if op CLI is installed
if ! command -v op &> /dev/null; then
    echo "âŒ 1Password CLI not installed. Run: brew install 1password-cli"
    exit 1
fi

# Try to get token from existing .localrc (either symlink target or file)
if [ -f "$LOCALRC_TARGET" ]; then
    source "$LOCALRC_TARGET"
    if [ -n "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
        echo "âœ“ Found existing OP token in .localrc"
        export OP_SERVICE_ACCOUNT_TOKEN
    fi
fi

# If no token, prompt for it
if [ -z "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
    echo ""
    echo "ðŸ”‘ First-time setup: Please provide your 1Password service account token"
    echo "   (Get it from: 1Password â†’ Settings â†’ Developer â†’ Service Accounts)"
    echo ""
    read -r "OP_SERVICE_ACCOUNT_TOKEN?Paste token: "
    export OP_SERVICE_ACCOUNT_TOKEN
fi

# Test authentication
echo "ðŸ” Authenticating with 1Password..."
if ! op whoami &> /dev/null; then
    echo "âŒ Authentication failed. Check your token."
    exit 1
fi

# Pull .localrc from 1Password secure note
echo "ðŸ“¥ Pulling .localrc from 1Password..."
op item get "$OP_ITEM_NAME" --vault "$OP_VAULT" --format json | jq -r '.fields[] | select(.label == "~/.localrc file contents") | .value' > "$LOCALRC_SYMLINK"

echo "âœ… localrc.symlink updated successfully!"
echo ""
echo "ðŸ’¡ Run 'script/bootstrap' to symlink it to ~/.localrc (or create symlink manually)"
echo "ðŸ”„ Run 'script/secrets' anytime to refresh secrets from 1Password"
